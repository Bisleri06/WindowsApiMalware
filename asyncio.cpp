#include<iostream>
#include<windows.h>
#include<cstdlib>
using namespace std;


//READ EXECUTES FIRST EVEN IF ITS WAIT IS LATER ON IN MAIN AND READS THE OLDER FILE
HANDLE hfile;

DWORD WINAPI readfunc()
{
    Sleep(1000);
    char buf[8];
    OVERLAPPED osop={0};
    SetFilePointer(hfile,0,NULL,FILE_BEGIN);
    ReadFile(hfile,buf,8,NULL,&osop);
    buf[8]='\0';
    cout<<buf<<endl;

    return 0;
}

void writefunc()
{
    Sleep(1000);
    OVERLAPPED osop={0};
    SetFilePointer(hfile,0,NULL,FILE_BEGIN);
    WriteFile(hfile,"12345678",8,NULL,&osop);
}


//read from EXISTING test.txt
int main()
{
    hfile=CreateFile("test.txt",GENERIC_READ | GENERIC_WRITE,FILE_SHARE_READ,NULL,OPEN_EXISTING,FILE_ATTRIBUTE_NORMAL|FILE_FLAG_OVERLAPPED,NULL);
    if(hfile==INVALID_HANDLE_VALUE){
        printf("ERROR");
        return 1;
    }

    HANDLE t1=CreateThread(0,0,(LPTHREAD_START_ROUTINE)readfunc,NULL,0,0);
    HANDLE t2=CreateThread(0,0,(LPTHREAD_START_ROUTINE)writefunc,NULL,0,0);
    WaitForSingleObject(t2,INFINITE);
    WaitForSingleObject(t1,INFINITE);
    
    cout<<"HERE"<<endl;
    readfunc();

    CloseHandle(t1);
    CloseHandle(t2);
    CloseHandle(hfile);  
}